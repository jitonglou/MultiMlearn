<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to MultiMlearn • MultiMlearn</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to MultiMlearn">
<meta property="og:description" content="MultiMlearn">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MultiMlearn</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example.html">Introduction to MultiMlearn</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jitonglou/MultiMlearn/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="example_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to MultiMlearn</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jitonglou/MultiMlearn/blob/master/vignettes/example.Rmd"><code>vignettes/example.Rmd</code></a></small>
      <div class="hidden name"><code>example.Rmd</code></div>

    </div>

    
    
<p>The <code>MultiMlearn</code> package is designed for estimating the individualized treatment rules (ITRs) under the setting of multicategory treatments. It is designed for data from observational studies (such as electronic health records), but it can also be used for randomized controlled trials. </p>
<p>The <code>MultiMlearn</code> package implements a matched learning (M-learning) model that uses the one-versus-one approach to convert the multicategory treatment comparison to a set of binary classification problems. </p>
<p>Also, the proposed model can incorporate the identified latent subgroup information to alleviate confounding effects among subjects and improve the performance of the M-learning. The coding example for subgroup identification can be found on <a href="https://github.com/jitonglou/IdSubgroup">this GitHub repository</a>, while it is currently not a function of the <code>MultiMlearn</code> package.</p>
<div id="documentation" class="section level2">
<h2 class="hasAnchor">
<a href="#documentation" class="anchor"></a>Documentation</h2>
<p>A simulation study illustrating the necessity of latent subgroup information can be found in <a href="https://github.com/jitonglou/MultiMlearn/blob/master/doc/supp_v3.pdf">this supplementary material</a>. The following explainatory example uses a similar simulation scenario to that stated in Section S.1.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>Install the development version using the <code>devtools</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"jitonglou/MultiMlearn"</span><span class="op">)</span></code></pre></div>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h2>
<p>Load the packages:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jitonglou/MultiMlearn">MultiMlearn</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jaredhuling.org/personalized/">personalized</a></span><span class="op">)</span></code></pre></div>
<div id="simulate-a-dataset" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-a-dataset" class="anchor"></a>Simulate a dataset</h3>
<p>Following the settings (equation (1), (2), (5), and (6)) in Section S.1.1 and S.1.2 of the <a href="https://github.com/jitonglou/MultiMlearn/blob/master/doc/supp_v3.pdf">supplementary material</a>, we simulate a dataset for N=200 subjects. The covariate vector <span class="math inline">\(\mathbf{x}_i\)</span> was set to be p=20 dimensional. Moreover, we set the number of treatments K=4, the number of groups J=4.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rseed</span> <span class="op">=</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">rseed</span><span class="op">)</span>

<span class="va">simdata</span> <span class="op">=</span> <span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span>
   N <span class="op">=</span> <span class="fl">200</span>, p <span class="op">=</span> <span class="fl">20</span>, K <span class="op">=</span> <span class="fl">4</span>, J <span class="op">=</span> <span class="fl">4</span>,
   propensity_func <span class="op">=</span> <span class="va">pi.true</span>, 
   main_func <span class="op">=</span> <span class="va">mu.true</span>, 
   interaction_func <span class="op">=</span> <span class="va">delta.true</span>
<span class="op">)</span>
<span class="co"># ?simulate_data # explanations of function arguments and the columns in the returned data frame </span>
<span class="co"># ?pi.true # true propensity model used in the supplementary material</span>
<span class="co"># ?mu.true # true main effects used in the supplementary material</span>
<span class="co"># ?delta.true # true interaction effects used in the supplementary material</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>treatment<span class="op">=</span><span class="va">simdata</span><span class="op">$</span><span class="va">treatment</span>, group<span class="op">=</span><span class="va">simdata</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span> <span class="co"># contingency table of observed treatment vs group</span>
<span class="co">#&gt;              group</span>
<span class="co">#&gt; treatment      1  2  3  4</span>
<span class="co">#&gt;   treatment_1 11 12 15 12</span>
<span class="co">#&gt;   treatment_2  9 10 14  8</span>
<span class="co">#&gt;   treatment_3 17 18 11  8</span>
<span class="co">#&gt;   treatment_4 13 15 11 16</span></code></pre></div>
</div>
<div id="estimate-propensity-and-prognostic-scores" class="section level3">
<h3 class="hasAnchor">
<a href="#estimate-propensity-and-prognostic-scores" class="anchor"></a>Estimate propensity and prognostic scores</h3>
<p>Next, we will show how to estimate propensity and prognostic scores using the random forest model. We take subjects in group 1 as an example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## extract features for subjects in group 1</span>
<span class="va">group</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">data_covariate</span> <span class="op">=</span> <span class="va">simdata</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cluster</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">cluster</span>, <span class="va">reward</span>, <span class="va">treatment</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"feature"</span><span class="op">)</span><span class="op">)</span>
<span class="va">n_feature</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">data_covariate</span><span class="op">)</span> <span class="op">-</span> <span class="fl">4</span></code></pre></div>
<div id="prognostic-scores" class="section level4">
<h4 class="hasAnchor">
<a href="#prognostic-scores" class="anchor"></a>Prognostic scores</h4>
<p>Train a random forest model to estimate prognostic scores. We selected the tuning parameters (<code>mtry</code> and <code>ntree</code>) by 10-fold cross-validation with 3 repeats.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ?rfcv2 # a customized function for using cross-validation to train random forests</span>
<span class="co">## tuning parameters</span>
<span class="va">metric</span> <span class="op">=</span> <span class="st">"RMSE"</span>
<span class="va">tunegrid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>.mtry<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_feature</span><span class="op">/</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, .ntree<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">500</span>,<span class="fl">2000</span>,<span class="fl">500</span><span class="op">)</span><span class="op">)</span>
<span class="va">control</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"repeatedcv"</span>, number<span class="op">=</span><span class="fl">10</span>, repeats<span class="op">=</span><span class="fl">3</span><span class="op">)</span>
<span class="co">## train model (around 1 minute)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">rseed</span><span class="op">)</span>
<span class="va">prognostic_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span>
  <span class="va">reward</span><span class="op">~</span><span class="va">.</span>, data<span class="op">=</span><span class="va">data_covariate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span>, <span class="op">-</span><span class="va">cluster</span>, <span class="op">-</span><span class="va">treatment</span><span class="op">)</span>,
  method<span class="op">=</span><span class="fu"><a href="../reference/rfcv2.html">rfcv2</a></span><span class="op">(</span><span class="st">"Regression"</span><span class="op">)</span>, metric<span class="op">=</span><span class="va">metric</span>,
  tuneGrid<span class="op">=</span><span class="va">tunegrid</span>, trControl<span class="op">=</span><span class="va">control</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">prognostic_fit</span><span class="op">)</span>
<span class="co">#&gt; 50 samples</span>
<span class="co">#&gt; 20 predictors</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; No pre-processing</span>
<span class="co">#&gt; Resampling: Cross-Validated (10 fold, repeated 3 times) </span>
<span class="co">#&gt; Summary of sample sizes: 44, 44, 46, 44, 46, 45, ... </span>
<span class="co">#&gt; Resampling results across tuning parameters:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   mtry  ntree  RMSE      Rsquared   MAE      </span>
<span class="co">#&gt;   1      500   1.263909  0.2374684  1.0026379</span>
<span class="co">#&gt;   1     1000   1.265846  0.2393138  1.0031806</span>
<span class="co">#&gt;   1     1500   1.265537  0.2690098  0.9996474</span>
<span class="co">#&gt;   1     2000   1.263070  0.2842502  1.0005525</span>
<span class="co">#&gt;   2      500   1.261495  0.2689129  1.0001293</span>
<span class="co">#&gt;   2     1000   1.259356  0.2693475  0.9959385</span>
<span class="co">#&gt;   2     1500   1.269358  0.2825926  1.0054877</span>
<span class="co">#&gt;   2     2000   1.266920  0.2703527  1.0049415</span>
<span class="co">#&gt;   3      500   1.265764  0.2692819  1.0019152</span>
<span class="co">#&gt;   3     1000   1.263893  0.2760030  1.0050117</span>
<span class="co">#&gt;   3     1500   1.263505  0.2996385  0.9989403</span>
<span class="co">#&gt;   3     2000   1.262860  0.2807268  1.0022529</span>
<span class="co">#&gt;   4      500   1.263106  0.3021249  1.0038525</span>
<span class="co">#&gt;   4     1000   1.261288  0.3009510  1.0047467</span>
<span class="co">#&gt;   4     1500   1.257289  0.2793284  1.0022257</span>
<span class="co">#&gt;   4     2000   1.261132  0.2931092  1.0017244</span>
<span class="co">#&gt;   5      500   1.268665  0.3075777  1.0083188</span>
<span class="co">#&gt;   5     1000   1.264453  0.2865868  1.0082328</span>
<span class="co">#&gt;   5     1500   1.260397  0.3052117  1.0038140</span>
<span class="co">#&gt;   5     2000   1.263131  0.3047422  1.0095299</span>
<span class="co">#&gt;   6      500   1.261791  0.3289496  1.0074004</span>
<span class="co">#&gt;   6     1000   1.264546  0.2682642  1.0127456</span>
<span class="co">#&gt;   6     1500   1.263643  0.2895696  1.0096727</span>
<span class="co">#&gt;   6     2000   1.261639  0.2971942  1.0095640</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; RMSE was used to select the optimal model using the smallest value.</span>
<span class="co">#&gt; The final values used for the model were mtry = 4 and ntree = 1500.</span>
<span class="co">## estimators</span>
<span class="va">sub_prog</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>
  <span class="va">prognostic_fit</span>, newdata<span class="op">=</span><span class="va">data_covariate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span>, <span class="op">-</span><span class="va">cluster</span>, <span class="op">-</span><span class="va">treatment</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="propensity-scores" class="section level4">
<h4 class="hasAnchor">
<a href="#propensity-scores" class="anchor"></a>Propensity scores</h4>
<p>Train a random forest model to estimate propensity scores. We selected the tuning parameters (<code>mtry</code> and <code>ntree</code>) by 10-fold cross-validation with 3 repeats.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## tuning parameters</span>
<span class="va">metric</span> <span class="op">=</span> <span class="st">"Kappa"</span>
<span class="va">tunegrid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>.mtry<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">n_feature</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, .ntree<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">500</span>,<span class="fl">2000</span>,<span class="fl">500</span><span class="op">)</span><span class="op">)</span>
<span class="va">control</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"repeatedcv"</span>, number<span class="op">=</span><span class="fl">10</span>, repeats<span class="op">=</span><span class="fl">3</span><span class="op">)</span>
<span class="co">## train model (around 1 minute)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">rseed</span><span class="op">)</span>
<span class="va">propensity_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span>
  <span class="va">treatment</span><span class="op">~</span><span class="va">.</span>, data<span class="op">=</span><span class="va">data_covariate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span>, <span class="op">-</span><span class="va">cluster</span>, <span class="op">-</span><span class="va">reward</span><span class="op">)</span>,
  method<span class="op">=</span><span class="fu"><a href="../reference/rfcv2.html">rfcv2</a></span><span class="op">(</span><span class="st">"Classification"</span><span class="op">)</span>, metric<span class="op">=</span><span class="va">metric</span>,
  tuneGrid<span class="op">=</span><span class="va">tunegrid</span>, trControl<span class="op">=</span><span class="va">control</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">propensity_fit</span><span class="op">)</span>
<span class="co">#&gt; 50 samples</span>
<span class="co">#&gt; 20 predictors</span>
<span class="co">#&gt;  4 classes: 'treatment_1', 'treatment_2', 'treatment_3', 'treatment_4' </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; No pre-processing</span>
<span class="co">#&gt; Resampling: Cross-Validated (10 fold, repeated 3 times) </span>
<span class="co">#&gt; Summary of sample sizes: 46, 46, 45, 46, 45, 44, ... </span>
<span class="co">#&gt; Resampling results across tuning parameters:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   mtry  ntree  Accuracy   Kappa        </span>
<span class="co">#&gt;   1      500   0.2327778  -0.0593179571</span>
<span class="co">#&gt;   1     1000   0.2572222  -0.0343456824</span>
<span class="co">#&gt;   1     1500   0.2683333  -0.0192242028</span>
<span class="co">#&gt;   1     2000   0.2616667  -0.0329631332</span>
<span class="co">#&gt;   2      500   0.2394444  -0.0452919214</span>
<span class="co">#&gt;   2     1000   0.2433333  -0.0381937624</span>
<span class="co">#&gt;   2     1500   0.2627778  -0.0181223106</span>
<span class="co">#&gt;   2     2000   0.2422222  -0.0399217290</span>
<span class="co">#&gt;   3      500   0.2694444   0.0046937196</span>
<span class="co">#&gt;   3     1000   0.2816667   0.0200164949</span>
<span class="co">#&gt;   3     1500   0.2750000   0.0118664062</span>
<span class="co">#&gt;   3     2000   0.2638889  -0.0074735034</span>
<span class="co">#&gt;   4      500   0.2622222  -0.0008315157</span>
<span class="co">#&gt;   4     1000   0.2611111  -0.0084169858</span>
<span class="co">#&gt;   4     1500   0.2761111   0.0126289334</span>
<span class="co">#&gt;   4     2000   0.2694444   0.0028106787</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Kappa was used to select the optimal model using the largest value.</span>
<span class="co">#&gt; The final values used for the model were mtry = 3 and ntree = 1000.</span>
<span class="co">## estimators</span>
<span class="va">sub_prop</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>
  <span class="va">propensity_fit</span>, newdata<span class="op">=</span><span class="va">data_covariate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span>, <span class="op">-</span><span class="va">cluster</span>, <span class="op">-</span><span class="va">reward</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"prob"</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
<div id="estimate-itrs-using-the-proposed-m-learning-model" class="section level3">
<h3 class="hasAnchor">
<a href="#estimate-itrs-using-the-proposed-m-learning-model" class="anchor"></a>Estimate ITRs using the proposed M-learning model</h3>
<p>We performs a nested cross-validation (on tuning parameters) of weighted support vector machines (SVMs) to fit the M-learning model and estimate ITRs.</p>
<div id="create-the-final-dataset-and-compute-distance-between-subjects" class="section level4">
<h4 class="hasAnchor">
<a href="#create-the-final-dataset-and-compute-distance-between-subjects" class="anchor"></a>Create the final dataset and compute distance between subjects</h4>
<p>Incorporate the estimated propensity and prognostics scores to the feature set, and compute the Euclidean distance between subjects based on the features.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## final data frame</span>
<span class="va">data_feature</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  <span class="va">data_covariate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>reward_res <span class="op">=</span> <span class="va">reward</span><span class="op">)</span>,
  <span class="va">sub_prop</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># remove propensity scores of the first treatment to avoid colinearity of propensity scores</span>
  prog <span class="op">=</span> <span class="va">sub_prog</span>
<span class="op">)</span>

<span class="co">## compute the Euclidean distance between features of subjects</span>
<span class="va">dist_feature</span> <span class="op">=</span> <span class="va">data_feature</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span>, <span class="op">-</span><span class="va">cluster</span>, <span class="op">-</span><span class="va">treatment</span>, <span class="op">-</span><span class="va">reward</span>, <span class="op">-</span><span class="va">reward_res</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dist_feature</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#&gt;   0.000   3.498   3.869   3.810   4.235   6.276</span>

<span class="co">## Create an index data frame to select the corresponding row of the distance matrix</span>
<span class="va">idx_data_feature</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ID<span class="op">=</span><span class="va">data_feature</span><span class="op">$</span><span class="va">ID</span>, index<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_feature</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
</div>
<div id="fit-the-m-learning-model" class="section level4">
<h4 class="hasAnchor">
<a href="#fit-the-m-learning-model" class="anchor"></a>Fit the M-learning model</h4>
<p>We split the data to 3 folds by letting <code>nfolds_outer=3</code>. In each test fold, the tuning parameter in SVMs (cost of constraints violation) is selected from <span class="math inline">\(\{2^k:k=0,\pm1,\ldots,\pm8\}\)</span> using another layer of 3-fold cross-validation (<code>nfolds_inner=3</code>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## User inputs</span>
<span class="va">ksvm.grid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>C <span class="op">=</span> <span class="fl">2</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">8</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="co"># a data frame of the tuning parameter</span>
<span class="va">nfolds_outer</span> <span class="op">=</span> <span class="fl">3</span> <span class="co"># number of folds in the outer layer of the nested cross-validation</span>
<span class="va">nfolds_inner</span> <span class="op">=</span> <span class="fl">3</span> <span class="co"># number of folds in the inner layer of the nested cross-validation</span>
<span class="va">g_func</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span> <span class="co"># weights on the outcome in support vector machines</span>
<span class="va">max_size</span> <span class="op">=</span> <span class="fl">1</span> <span class="co"># maximum size of the matched set</span>

<span class="co">## Fit M-learning model (around 1 minute)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">rseed</span><span class="op">)</span>
<span class="co"># ?mlearn.wsvm.cv # explanation of arguments</span>
<span class="va">ITR</span> <span class="op">=</span> <span class="fu"><a href="../reference/mlearn.wsvm.cv.html">mlearn.wsvm.cv</a></span><span class="op">(</span>
  data<span class="op">=</span><span class="va">data_feature</span>, idx<span class="op">=</span><span class="va">idx_data_feature</span>,
  trts<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">data_feature</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span>, max_size<span class="op">=</span><span class="va">max_size</span>,
  delta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">dist_feature</span><span class="op">)</span>, dist_mat<span class="op">=</span><span class="va">dist_feature</span>, g_func<span class="op">=</span><span class="va">g_func</span>,
  kernel<span class="op">=</span><span class="st">"rbfdot"</span>, kpar<span class="op">=</span><span class="st">"automatic"</span>,
  nfolds_outer<span class="op">=</span><span class="va">nfolds_outer</span>, nfolds_inner<span class="op">=</span><span class="va">nfolds_inner</span>, tuneGrid<span class="op">=</span><span class="va">ksvm.grid</span>, propensity<span class="op">=</span><span class="va">sub_prop</span>,
  foldid_outer<span class="op">=</span><span class="cn">NULL</span>
<span class="op">)</span>
<span class="co">#&gt; [1] "Outer fold 1 has 33 training samples."</span>
<span class="co">#&gt; [1] "Outer fold 1 is done."</span>
<span class="co">#&gt; [1] "Outer fold 2 has 33 training samples."</span>
<span class="co">#&gt; [1] "Outer fold 2 is done."</span>
<span class="co">#&gt; [1] "Outer fold 3 has 34 training samples."</span>
<span class="co">#&gt; [1] "Outer fold 3 is done."</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ITR</span><span class="op">)</span>
<span class="co">#&gt;              Length Class      Mode   </span>
<span class="co">#&gt; fit           3     -none-     list   </span>
<span class="co">#&gt; foldid_outer 50     -none-     numeric</span>
<span class="co">#&gt; prediction    5     data.frame list</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ITR</span><span class="op">$</span><span class="va">prediction</span><span class="op">)</span> <span class="co"># "vote" represents the recommended treatments for the subjects. "treatment" represents the observed treatments.</span>
<span class="co">#&gt;   ID    reward   treatment        vote fold</span>
<span class="co">#&gt; 1  2 2.7538025 treatment_1 treatment_1    2</span>
<span class="co">#&gt; 2  5 0.3607558 treatment_3 treatment_1    1</span>
<span class="co">#&gt; 3  7 3.5833142 treatment_1 treatment_1    3</span>
<span class="co">#&gt; 4 14 0.8700615 treatment_2 treatment_1    1</span>
<span class="co">#&gt; 5 15 0.4640756 treatment_2 treatment_1    1</span>
<span class="co">#&gt; 6 16 2.5734038 treatment_3 treatment_1    2</span></code></pre></div>
</div>
</div>
<div id="summarize-results" class="section level3">
<h3 class="hasAnchor">
<a href="#summarize-results" class="anchor"></a>Summarize results</h3>
<p>We extract the recommended treatments of the ITR, and then calculate the empirical value function (EVF) and misclassification rate as equation (3) and equation (4) in the <a href="https://github.com/jitonglou/MultiMlearn/blob/master/doc/supp_v3.pdf">supplementary material</a>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create a function to calculate EVF</span>
<span class="va">evf.func</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">reward</span>, <span class="va">pi</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">{</span>
  <span class="va">flag</span> <span class="op">=</span> <span class="op">(</span><span class="va">x</span><span class="op">==</span><span class="va">y</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">reward</span><span class="op">/</span><span class="va">pi</span><span class="op">)</span><span class="op">[</span><span class="va">flag</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">pi</span><span class="op">)</span><span class="op">[</span><span class="va">flag</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## EVF and misclassification rate of observed and recommended treatments</span>
<span class="va">summary_evf</span> <span class="op">=</span> <span class="va">ITR</span><span class="op">$</span><span class="va">prediction</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">simdata</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">pi_true</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"opt"</span><span class="op">)</span><span class="op">)</span>, <span class="co"># join the simdata to use true propensity score and optimal treatment information</span>
            by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">fold</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>
      evf_obs <span class="op">=</span> <span class="fu">evf.func</span><span class="op">(</span><span class="va">reward</span>, <span class="va">pi_true</span>, <span class="va">treatment</span>, <span class="va">treatment</span><span class="op">)</span>,
      mis_obs <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_opt</span> <span class="op">==</span> <span class="va">treatment</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
      evf_rec <span class="op">=</span> <span class="fu">evf.func</span><span class="op">(</span><span class="va">reward</span>, <span class="va">pi_true</span>, <span class="va">treatment</span>, <span class="va">vote</span><span class="op">)</span>, 
      mis_rec <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">treatment_opt</span> <span class="op">==</span> <span class="va">vote</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
    n<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># sample size in each fold</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">as.data.frame</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">summary_evf</span><span class="op">)</span>
<span class="co">#&gt;       fold        evf_obs          mis_obs          evf_rec          mis_rec </span>
<span class="co">#&gt;  Min.   :1.0   Min.   :0.8164   Min.   :0.7059   Min.   :0.8785   Min.   :0  </span>
<span class="co">#&gt;  1st Qu.:1.5   1st Qu.:0.9893   1st Qu.:0.7592   1st Qu.:1.4472   1st Qu.:0  </span>
<span class="co">#&gt;  Median :2.0   Median :1.1622   Median :0.8125   Median :2.0159   Median :0  </span>
<span class="co">#&gt;  Mean   :2.0   Mean   :1.1692   Mean   :0.7806   Mean   :2.1850   Mean   :0  </span>
<span class="co">#&gt;  3rd Qu.:2.5   3rd Qu.:1.3456   3rd Qu.:0.8180   3rd Qu.:2.8382   3rd Qu.:0  </span>
<span class="co">#&gt;  Max.   :3.0   Max.   :1.5289   Max.   :0.8235   Max.   :3.6604   Max.   :0  </span>
<span class="co">#&gt;        n        </span>
<span class="co">#&gt;  Min.   :16.00  </span>
<span class="co">#&gt;  1st Qu.:16.50  </span>
<span class="co">#&gt;  Median :17.00  </span>
<span class="co">#&gt;  Mean   :16.67  </span>
<span class="co">#&gt;  3rd Qu.:17.00  </span>
<span class="co">#&gt;  Max.   :17.00</span></code></pre></div>
<p>Compared with the observed treatments, the recommended treatments by M-learning have a greater EVF (2.0159 vs 1.1622) and a lower misclassification rate (0 vs. 0.7806) on average.  To reproduce the results in Table S1 and Figure S1 in Section S.1.3 of the <a href="https://github.com/jitonglou/MultiMlearn/blob/master/doc/supp_v3.pdf">supplementary material</a>, you need to run the above scripts for group 2 to 4, and repeat the procedure for 100 times using <code>rseed=1,...,100</code>, <code>ntree=seq(500,5000,500)</code>, <code>ksvm.grid = expand.grid(C = 2^(-15:15))</code>, <code>nfolds_outer = 5</code>, and <code>nfolds_outer = 5</code>. Each replication can be done by parallel computing.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jitong Lou.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
